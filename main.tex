% press command+option+B to build, or change "Auto Build: Run" in Settings.

\documentclass{book}

\usepackage{xeCJK}
\usepackage{geometry}
\usepackage{titlesec}

\usepackage{underlin}
\usepackage{wrapfig}
\usepackage{caption}
\usepackage{graphicx}
\usepackage{psfrag}
\usepackage{subfig}
% \usepackage{dvips}
\usepackage{pdfpages}
\usepackage{multirow}%表格合并行列单元格

% 分栏并浮动图片
\usepackage{float}
\usepackage{multicol}
\usepackage[none]{hyphenat}
\usepackage{appendix}

% 数学
\usepackage{unicode-math}%正体希腊字母
\usepackage{pifont}%原书使用的特殊符号输入
%TODO 可以拿来输入整体希腊字母，但不清楚是否能拿来解决跟unicode-math冲突的问题

\usepackage{mathrsfs}
\usepackage{amsfonts}
\usepackage{bm}
\usepackage{bbm}
\usepackage{textcomp}

%代码抄录
\usepackage{listings}

% 设置图书版式
\usepackage{marginnote}%侧栏
\usepackage{fancyhdr}%页眉页脚页码
\usepackage{indentfirst}%首段空两格
\usepackage{mdframed}%加阴影
\usepackage{xcolor}%特殊字体颜色
\usepackage{setspace}%行距
\usepackage{hyperref}%所有网页用超链接同步挂靠
\usepackage{xpatch}%设置verbatim前后间距
\usepackage{mflogo}%METAPOST和METAFONT logo

%行号
\usepackage{lineno}

%圆角边框
\usepackage{fancybox}

%首字下沉
\usepackage{lettrine}

%特殊字体
\usepackage{fontspec}

%页面奇偶性判断
\usepackage{ifthen}
\usepackage{chngpage}

%用于VerbatimInput等照抄情况
\usepackage{fancyvrb}

%附录用包
% \usepackage{tikz}
\usepackage{pstricks}
\usepackage{pst-plot}
\usepackage{psfrag}

\newcommand\codereplace[1]{%代码中的<可替换>部分
    {\xeCJKsetup{CJKecglue={\hskip 0pt}}%
    {\rm ⟨}\textsl{#1}{\rm ⟩}}}

\newcommand\wz[1]{%网址
    {\ttfamily #1}}

\newcommand\jz[1]{%原书脚注
    \footnote{#1}}

\newcommand\yz[1]{%译注
    \footnote{\textsl{译注：}#1}}

\newcommand\dm[1]{%代码
    \texttt{#1}}

\newcommand\dmh[1]{%代码行TODO 兼容多行
    \xeCJKsetup{CJKecglue={\hskip 0pt}}%
    \char"258E \texttt{#1}
    }


\newcommand\celan[1]{%侧栏
    \checkoddpage 
    \ifcpoddpage{
        \footnotesize $\blacktriangleright$%
        \marginpar{%
        \footnotesize%
        $\blacktriangleleft$ \textsf{#1}}}
    \else{
        \footnotesize $\blacktriangleleft$%
        \marginpar{%
        \footnotesize%
        $\blacktriangleright$ \textsf{#1}}}
    \fi}

%bibtex logo
\def\bib{B\textsc{IB}\TeX}

%原书的提示框
%NOTE 这几个环绕形式都会产生问题：要求内容至少占2行。法文篇幅比中文长，所以这种问题没有凸显出来。但到了译文中，这个问题是我们必须要注意的问题。目前采用的解决方案比较简单粗暴：如果译文没有占到2行，则手动添加一个空行。
\newlength{\larnota}
\newlength{\largligne}
\newlength{\padnota}
\newlength{\indnota}

\definecolor{LightPink}{RGB}{230,173,173}
\definecolor{LightBlue}{RGB}{173,216,230}

\newcommand\nota[1]{%
    \setlength{\padnota}{5pt}%
    \setlength{\larnota}{.9cm}%
    \setlength{\indnota}{\larnota+\padnota}%
    \setlength{\largligne}{\textwidth-\indnota}%
    \sffamily%
    \parshape=3%
        \indnota\largligne%
        \indnota\largligne%
        0pt\textwidth\noindent%
    \raisebox{-\larnota+2.2ex}[0pt][0pt]{%
    \makebox[0pt][r]{%
    \includegraphics[width=\larnota]{#1}%
    \hspace*{\padnota}}}\ignorespaces}

%原书的圆圈感叹号
\newenvironment{exclamation}{%
    \begin{mdframed}[backgroundcolor=LightPink,%
        hidealllines=true]%
    \nota{img/fmb-important}}%
    {%
    \end{mdframed}%
}

%原书的圆圈问号
\newenvironment{qquestion}{%
    \begin{mdframed}[backgroundcolor=LightPink,%
        hidealllines=true]%
    \nota{img/fmb-question}}{%
    \end{mdframed}%
}

%原书的圆圈i
\newenvironment{ii}{%
    \begin{mdframed}[backgroundcolor=LightBlue,%
        hidealllines=true]%
    \nota{img/fmb-note}}{%
    \end{mdframed}%
}

\newenvironment{dmd}{%代码段
    \xeCJKsetup{CJKecglue={\hskip 0pt}}
    \vspace{0.5em}
    \ttfamily
    \setlength{\parindent}{0pt}
}{
    \rmfamily
    \vspace{0.5em}
}

%代码清单
%NOTE 代码清单序号在翻译时进行了手动调整，跟原书有较大差别，不用自动计数为宜
\makeatletter

\newsavebox{\b@iteentree}
\newsavebox{\b@itesortie}
\newsavebox{\list@nb}
\newsavebox{\bitebxedminipage}
\newlength{\ltxexmargintdeborde}
\newlength{\ltxexmargextdeborde}

\setlength{\ltxexmargintdeborde}{5mm}
\setlength{\ltxexmargextdeborde}{10mm}

\newcommand{\ltxexoutputwidthpercent}{44}
\newcommand{\ltxexinputwidthpercent}{53}
\newcommand{\ltxexoutputwidthratio}{.\ltxexoutputwidthpercent}
\newcommand{\ltxexinputwidthratio}{.\ltxexinputwidthpercent}

\newenvironment{ltxexempleenv}{%
    \noindent
    }{}

\newlength{\hauteurdutrait}
\newlength{\tempodim}

\newcommand{\hauteurtotale}[2]{%
    % 存储要测量的对象
    \setbox\@tempboxa\hbox{{#2}}%
    % 获取高度
    \setlength{#1}{\ht\@tempboxa}% 
    % 在高度基础上加上深度
    \addtolength{#1}{\dp\@tempboxa}%
    % 排空临时字盒
    \setbox\@tempboxa\box\voidb@x}%

\newenvironment{codelist}[2][TODO代码清单序号]{%
    \setlength{\fboxsep}{.5pt}%
    \savebox{\b@itesortie}{%
    \begin{minipage}{\ltxexoutputwidthratio\linewidth} 
        \setlength{\parindent}{10pt}%
        #2%把文件效果誊写进来
    \end{minipage}}%
    \savebox{\list@nb}{%
        \raisebox{-1.7pt}[0pt][0pt]{% 
        \setlength{\fboxsep}{.7pt}%
        \colorbox{black}{% 
        \makebox[16pt]{%
        \color{white}%
        \tiny\sffamily{\textbf{#1}}}}}%
    }
    \VerbatimEnvironment%
    \begin{VerbatimOut}{\jobname.exa}}{
    \end{VerbatimOut}%照抄到外面的文件
    \begin{ltxexempleenv}%
        \savebox{\b@iteentree}{%
        \begin{minipage}{\ltxexinputwidthratio\linewidth}
            \input{\jobname.exa}%\VerbatimInput{\jobname.exa}%照抄进来
        \end{minipage}}%
        % 测量入口字盒 
        \hauteurtotale{\tempodim}{\usebox{\b@iteentree}}%
        % 测量出口字盒 
        \hauteurtotale{\hauteurdutrait}{\usebox{\b@itesortie}}%
        % 取较大值
        \ifthenelse{\hauteurdutrait<\tempodim}{%
            \setlength{\hauteurdutrait}{\tempodim}}{}%
        \addtolength{\hauteurdutrait}{-16pt}
        %开始绘制
        \usebox{\b@iteentree}%
        \parbox{3pt}{%
        \begin{center}%
            \rule{2pt}{.7\hauteurdutrait}\\\nointerlineskip
            \rotatebox{90}{\usebox{\list@nb}}\\\nointerlineskip
            \rule{2pt}{.3\hauteurdutrait}%
        \end{center}}%
        \kern4pt%
        \usebox{\b@itesortie}%
    \end{ltxexempleenv}}%
\makeatother%

%字体
\setCJKmainfont[
    BoldFont={FandolSong-Bold}, % 破产宋 Bold
    ItalicFont={FandolKai-Regular}, % 破产楷
    SlantedFont={FandolFang-Regular}, % 破产仿宋
    ]{STSongti-SC-Regular}  % 破产宋 Regular
\setCJKsansfont[
    BoldFont={NotoSansCJKsc-Bold}, % 思源黑
    ItalicFont={DingTalk-JinBuTi},% 钉钉进步体
    SlantedFont={FandolFang-Regular}, % 破产仿宋
    ]{NotoSansCJKsc-DemiLight} % 思源黑半轻
\setCJKmonofont[
    BoldFont={PingFangSC-Semibold}, % 苹方中黑
    ItalicFont={HannotateSC-W7},% 手札体常规
    SlantedFont={FandolFang-Regular}, % 破产仿宋
    ]{HYZhengYuan-EEW} % 汉仪正圆
% \setmonofont[
%     BoldFont={FiraCodeRoman-SemiBold},
%     ItalicFont={JetBrainsMonoNL-Italic}, 
%     ]{FiraCodeRoman-Regular}

%特殊字符的字体显示
\xeCJKDeclareSubCJKBlock{angleBracket}{
    "27E8 -> "27E9, %〈〉半角括号
    "25B4 %▴
}
\setCJKmainfont[angleBracket]{STIXTwoMath-Regular}

\xeCJKsetcharclass{"2580}{"259F}{1}%侧栏小方块示例
\xeCJKsetcharclass{"211A}{"211F}{1}%双钩R
\xeCJKsetcharclass{"0370}{"03FF}{1}%希腊字母
\xeCJKsetup{AutoFallBack=true}
\setCJKfallbackfamilyfont{\CJKrmdefault}{ArialUnicodeMS}

%带跳转的内容颜色
\definecolor{MediumBlue}{RGB}{0,0,205}
\hypersetup{
    colorlinks = true,
    linkcolor = MediumBlue
}

\title{关于\LaTeX 的那些你想知道却从不敢问的问题\\或者说，如何在不会使用\LaTeX 的情况下使用\LaTeX \\{\normalsize Tout ce que vous avez toujours voulu savoir sur \LaTeX \ sans jamais oser le demander\\Ou comment utiliser \LaTeX \ quand on n'y connaît goutte\\~\\ ver. 1.5}}
\author{Vincent Lozano 著}

\begin{document}

%去除空白页页眉页脚
\makeatletter
\renewcommand{\cleardoublepage}{% 重定义该指令
    \clearpage\ifodd\c@page\else
    \hbox{}
    \vspace*{\fill}
    \thispagestyle{empty}% 添加此行 
    \newpage
    \fi}
\makeatother

\maketitle

%正文版式
\newgeometry{
    % inner = 2cm, outer = 4cm,
    % top = 2.5cm, bottom=2.5cm, 
    marginparwidth = 2cm, marginparsep = 0.5cm,
    % includeheadfoot
}
\pagestyle{fancy}

%原书页眉定义
\fancyhf{}
\fancyhead[LE]{\bfseries\thepage}
\fancyhead[RO]{\bfseries\thepage}
\fancyhead[LO]{\bfseries\rightmark}
\fancyhead[RE]{\bfseries\leftmark}
\renewcommand{\footrulewidth}{0pt}

%章首版式
\fancypagestyle{plain}{%
    \fancyhf{}% 全部清空 
    \fancyfoot[C]{\thepage}% 页面底部的页码
    % 清空所有线条
    \renewcommand{\headrulewidth}{0pt}% 
    \renewcommand{\footrulewidth}{0pt}}

%verbatim设置为不特殊打断，会根据代码内容与\verb 和\texttt混用
\xpretocmd\verbatim{
    \setlength{\topsep}{0pt}
    \setlength{\partopsep}{0pt}
    }{}{\fail}

\setstretch{1.2}

\frontmatter

\input{introduction-0.tex}
\input{lucrece.tex}
\input{introduction.tex}

\tableofcontents

\mainmatter

\input{chapitre1.tex}
\input{chapitre2.tex}
\input{chapitre3.tex}
\input{chapitre4.tex}
\input{chapitre5.tex}
\input{chapitre6.tex}
\input{chapitre7.tex}
\input{chapitre8.tex}

\input{introduction2.tex}
\input{chapitre9.tex}
\input{chapitre10.tex}
\input{chapitre11.tex}
\input{chapitreA.tex}
\input{chapitreB.tex}
\input{chapitreC.tex}
\input{chapitreD.tex}

\backmatter
\input{biliographie.tex}
\input{glossoire.tex}

\end{document}